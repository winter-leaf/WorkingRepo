---
title: floating point arounding
top: false
cover: false
toc: true
mathjax: true
date: 2020-01-12 11:21:39
password:
summary:
tags: representation
categories: Concept
---


最近有朋友问起来浮点数的取舍的进位误差，解释过程中，让我想起了很久前学习时写的小结。再次翻看，感觉挺有趣。
<!---more--->

# 1. 浮点数的表示
浮点数在底层表示的时候有一套规定标准IEEE 754，任何实现都要用这套标准来表示32位的浮点数值，从而可以保证理解的统一性。
它的形式是这样的:  |  S  |    E    |   M   |
S: sign, 1-bit, 符号值
E: exponent, 8-bit, 指数值
M: mantissa, 23-bit, 尾数值

最终表达的十进制结果是: [(-1)^S] x [1+M^(-23)] x [2^(E-127)]

举个例子，
| 1 | 11111110 | 11000......0 | , 其中S = 1, E = 254, M = 6591456
= [(-1)^1] x [1+(6591456)^(-23)] x [2^(254-127)]
= (-1) x 1.75 x 2^127

这里面M左移23位就相当于说，M的每一位都是二进制小数点后的数，2^(-1), 2^(-2), ..., 2^(-23)。M转化到十进制的之后也是出现在小数点之后。这也是它为什么叫尾数。

但这里有两个点要仔细想一下:
1. 为什么要加在M前加个1? 用[0+M^(-23)]不是也可以吗，只不过是多移动一次小数点?
2. 这里很明显的可以看出来M的值是2的负指数次幂，最终只能表示'0.xx...xx5'形式的数，其他形式的数类似'0.xx...xx3'是不能表示的。那怎么办?

## 问题 1
理论上，我们可以用[0+M^(-23)]来表示，这并不是不可能的，而且思维上也更符合十进制的科学记数法。但在二进制的世界，这会带来一个问题，它会破坏数值的唯一表示性。还是拿上面的例子，(-1) x 1.75 x 2^127
用[0+M^(-23)]来表示则可以是:
(-1) x 1.75 x 2^127
= (-1) x 0.875 x 2 x 2^127
= (-1) x 0.875 x 2^128
记这个结果转化为浮点数表示后为| S1 | E1 | M1 |

同样的道理我可以用另一个分解来表示
(-1) x 1.75 x 2^127
= (-1) x 0.4375 x 4 x 2^127
= (-1) x 0.4375 x 2^129
记这个结果转化为浮点数表示后为| S2 | E2 | M2 |

最终我们看到，| S1 | E1 | M1 | 和 | S2 | E2 | M2 |两个浮点数来表达同一个十进制数值。类似的我们还可以找出来更多。这种非1-1对应的表示法有两个困扰:
* (1)一个十进制小数会占据多个浮点数表示结果，浪费表示空间。
* (2)如果用两个浮点数做比较，由于两个浮点数可能代表同一个十进制值，我们不能快速的看出两个浮点数谁大，只好转换到十进制来看。

所以[0+M^(-23)]的形式来表示并不是一个好的选择。

## 问题 2
这个问题就是进位取舍时的问题，当一个十进制数转化为浮点数形式后的M，是一个23位装不下的数时，M会根据最后多出的那一位做‘逢一进位’。
举个例子，十进制0.6转化为二进制后为0.100110011001...，是一个在二进制下无限循环的数。
进一步转化成浮点数:
0.100110011001...
= +1.00110011001... x 2^(-1)
那么S = 0, E = 126, M = 00110011001100110011001(1)...
最后在多出那个位上是一个1, 我们要进位最终M=00110011001100110011010
这个结果如果在转回十进制，显然不会是0.6, 而是0.600000xxx...。这个近似的精度会随着M含有的位数而增加，如果用64位的浮点数表示，那么进位取舍后的小数值要更接近真值。
所以我们想要用浮点数来表示一个非2倍数的十进制小数，就会在值很小的位数上有误差，比如1.3, 可能真正在计算机中会是类似1.300000000000000100这样一个值。

这也是为什么有时会看到这样一个说法，浮点数类型的数值不能比较=或!=，但可以比较>,<,>=,<=。原因在于这个精度的取舍。

同理还有十进制的0, 因为结合上面的[1+M^(-23)]表示法，无论如何我们无法用正常的浮点数表示形式构件出一个0. 
所以0在浮点数中是一个特殊值，且分为+0和-0,
正0用| 0 | 00000000 | 00000000000000000000000 |
负0用| 1 | 00000000 | 00000000000000000000000 |
